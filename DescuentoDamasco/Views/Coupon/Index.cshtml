@*
    
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "~/Views/Shared/_LayoutCupon.cshtml";
    @model DescuentoDamasco.Models.DescuentoModel
   
}

<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<div class="form-client">

    <div class="container-fluid">
        <style>
            .error-message {
                color: red;
                font-size: 14px;
                margin-top: 5px;
            }
        </style>
        <div class="logos col mt-3">
            <div class="brand-image">
                <img src="~/img/logodamascorojo.png" alt="Damasco Rojo Logo">
            </div>
        </div>
        <div class="d-flex justify-content-center">
            <h3>Generar Guia de Despacho Tienda</h3>
        </div>
        <div class="row g-2">
            <form id="cupon-form" >
                <div class="form-group">
                    <label for="SucursalId">Sucursales</label>
                    <select asp-for="SucursalId" id="SucursalDestino" asp-items="Model.Sucursales" class="form-control">
                        <option value="">Seleccione una sucursal</option>
                    </select>
                    <span id="sucursal-error" class="error-message"></span>
                </div>
                <div class="col form-group">
                    <label for="">Número de factura</label>
                    <input type="text" id="num-fac" placeholder="Número de factura" class="form-control">
                    <span id="num-fac-error" class="error-message"></span>
                </div>
                <div class="col form-group">
                    <label for="">Fecha de Factura</label>
                    <input type="date" name="fecha-factura" id="fecha-factura" class="form-control">

                </div>
                <div class="row">
                    <div class="col form-group">

                        <div class="row">
                            <label for="">Documento de identidad</label>
                            <div class="col form-group">

                                <select name="" class="form-select" id="tipo-doc">
                                    <option value="">Elige</option>
                                    <option value="V">V</option>
                                    <option value="E">J</option>
                                </select>
                                <span id="tipo-ced-error" class="error-message"></span>
                            </div>
                            <div class="col form-group">

                                <input type="text" placeholder="Número de cedula" id="num-doc" class="form-control">
                                <span id="num-doc-error" class="error-message"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col form-group">
                        <label for="">Nombre </label>
                        <input type="text" id="Nombre" placeholder="Nombre" class="form-control">
                        <span id="nombre-error" class="error-message"></span>
                    </div>
                    <div class="col form-group">
                        <label for="">Apellido</label>
                        <input type="text" id="Apellido" placeholder="Apellido" class="form-control">
                        <span id="apellido-error" class="error-message"></span>
                    </div>
                    <div class="col form-group">
                        <label for="">Fecha de nacimiento</label>
                        <input type="date" name="fecha-nac" id="fecha-nac" class="form-control">
                        <span id="fecha-nac-error" class="error-message"></span>
                    </div>

                </div>
                <div class="row g-2">
                    <div class="col">
                        <label for="est-cil">
                            Estado Civil
                        </label>
                        <select name="estado" class="form-select" id="estado-civil">
                            <option value="">Elige</option>
                            <option value="S">Soltero</option>
                            <option value="C">Casado</option>
                            <option value="D">Divorciado</option>
                            <option value="V">Viudo</option>
                        </select>
                        <span id="estado-civil-error" class="error-message"></span>
                    </div>
                    <div class="col">
                        <label for="genero-cliente">Sexo</label>
                        <select name="genero" class="form-select" id="genero-cliente">
                            <option value="M">Masculino</option>
                            <option value="F">Femenino</option>
                        </select>
                        <span id="genero-cliente-error" class="error-message"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="">Correo electronico</label>
                    <input type="text" id="Correo" name="Correo" placeholder="Correo electrónico" class="form-control">
                    <span id="correo-error" class="error-message"></span>
                </div>
                <div class="row g-2">
                    <div class="col form-group">
                        <label for="">
                            Número de teléfono
                        </label>
                        <select name="" class="form-select" id="cod-telf">
                            <option value="">Elige</option>
                            <option value="0412">0412</option>
                            <option value="0414">0414</option>
                            <option value="0424">0424</option>
                            <option value="0416">0416</option>
                            <option value="0426">0426</option>
                        </select>
                        <span id="cod-telf-error" class="error-message"></span>
                    </div>
                    <div class="col form-group">
                        <label for=""></label>
                        <input type="text" id="num-telf" placeholder="Número de teléfono" class="form-control">
                        <span id="num-telf-error" class="error-message"></span>
                    </div>
                </div>

                <div class="row g-5">
                    <div class="col form-group">
                        <label for="">País de emisión</label>
                        <select name="" class="form-select" id="country" onchange="getState()">
                            <option value="">Elige</option>
                            <option value="1">Venezuela</option>
                        </select>
                        <span id="country-error" class="error-message"></span>
                    </div>
                    <div class="col form-group">
                        <label for="">Estado</label>
                        <select name="" class="form-select estado-emision" id="estado-emision" onchange="getMunicipality()">
                        </select>
                        <span id="estado-error" class="error-message"></span>
                    </div>
                    <div class="col form-group">
                        <label for="">Municipio</label>
                        <select name="" class="form-select municipio-emision" id="municipio-emision" onchange="getCity()">
                        </select>
                        <span id="municipio-error" class="error-message"></span>
                    </div>
                    <div class="col form-group">
                        <label for="">Ciudad</label>
                        <select name="" class="form-select ciudad-emision" id="ciudad-emision" onchange="getZones()">
                        </select>
                        <span id="ciudad-error" class="error-message"></span>
                    </div>
                    <div class="col form-group">
                        <label for="">Zona</label>
                        <select name="" class="form-select zona-emision" id="Zona-emision">
                        </select>
                        <span id="zona-error" class="error-message"></span>
                    </div>
                </div>


            @*     <div class="form-group">
                    <label for="total-factura">Total de Factura</label>
                    <input type="text" id="total-factura" name="totalFactura" class="form-control" placeholder="Total de Factura" readonly>
                    <span id="total-facturar-error" class="error-message"></span>
                </div>
                <div class="form-group">
                    <label for="total-descuento">Total de Descuento</label>
                    <input type="text" id="total-descuento" name="totalFactura" class="form-control" placeholder="Total de Descuento" readonly>

                </div> *@

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary" id="confirm-btn">Generar Guía Despacho </button>

                </div>


                </form>
        </div>
    </div>
    <script>
        let facturaData = []; // Declarar la variable fuera de la función para que sea accesible

        async function getState() {
            let countryVal = document.getElementById('country').value;
            try {
                const response = await fetch(`/Coupon/GetStates?cntry=${countryVal}`);
                if (response.ok) {
                    const data = await response.json();
                    const estados = data.prov.map(item => ({
                        id: item.provinceId,
                        text: item.provinceName
                    }));

                    estados.unshift({ id: '', text: 'Seleccione un Estado' });
                    $("#estado-emision").select2({ data: estados });
                } else {
                    throw new Error('Error al obtener los estados');
                }
            } catch (error) {
                alert(error.message);
            }
        }

        async function getMunicipality() {
            let stateVal = document.getElementById('estado-emision').value;
            try {
                const response = await fetch(`/Coupon/GetMunicipio?state=${stateVal}`);
                if (response.ok) {
                    const dataMun = await response.json();
                    const muns = dataMun.mun.map(items => ({
                        id: items.munucipId,
                        text: items.munucipName
                    }));

                    muns.unshift({ id: '', text: 'Seleccione un Municipio' });
                    $(".municipio-emision").empty().select2({ data: muns });
                } else {
                    throw new Error('Error al obtener los municipios');
                }
            } catch (error) {
                alert(error.message);
            }
        }

        async function getCity() {
            let stateVal = document.getElementById('estado-emision').value;
            try {
                const response = await fetch(`/Coupon/GetCities?state=${stateVal}`);
                if (response.ok) {
                    const dataCity = await response.json();
                    const city = dataCity.city.map(items => ({
                        id: items.cityId,
                        text: items.cityName
                    }));

                    city.unshift({ id: '', text: 'Seleccione una ciudad' });
                    $(".ciudad-emision").empty().select2({
                        data: city,
                        placeholder: "Seleccione una ciudad",
                        allowClear: true
                    });
                } else {
                    throw new Error('Error al obtener las ciudades');
                }
            } catch (error) {
                alert(error.message);
            }
        }

        async function getZones() {
            let stateVal = document.getElementById('estado-emision').value;
            let muniVal = document.getElementById('municipio-emision').value;
            try {
                const response = await fetch(`/Coupon/GetZone?state=${stateVal}&mun=${muniVal}`);
                if (response.ok) {
                    const dataZone = await response.json();
                    const zone = dataZone.zoneList.map(items => ({
                        id: items.zoneId,
                        text: items.zoneName
                    }));
                    $(".zona-emision").empty().select2({ data: zone });
                } else {
                    throw new Error('Error al obtener las zonas');
                }
            } catch (error) {
                alert(error.message);
            }
        }

        $(document).ready(function () {
            $('#SucursalDestino, #num-fac').on('change', function () {
                var sucursal = $('#SucursalDestino').val();
                var numFactura = $('#num-fac').val();

                limpiarCampos();

                if (sucursal && numFactura) {
                    $.ajax({
                        url: '/Coupon/ObtenerDatos',
                        type: 'GET',
                        data: {
                            sucursal: sucursal,
                            numFactura: numFactura
                        },
                        success: function (data) {
                            console.log('Datos recibidos:', data);
                            facturaData = data; // Asignar los datos recibidos a facturaData

                            if (data.length > 0) {
                                $('#fecha-factura').val(data[0].fechaFactura.split('T')[0]);

                                var cliente = data[0];
                                var codCliente = cliente.codCliente;
                                $('#tipo-doc').val(codCliente.charAt(0));
                                $('#num-doc').val(codCliente.substring(2));

                                var nombreArray = cliente.nomCliente.split(' ');
                                $('#Nombre').val(nombreArray[0]);
                                $('#Apellido').val(nombreArray[1] || '');
                            } else {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'No hay productos disponibles',
                                    text: 'No se encontraron productos para esta factura.',
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error al obtener datos',
                                text: 'Hubo un problema al cargar los productos. Inténtalo de nuevo más tarde.',
                            });
                            console.error('Error al obtener datos:', status, error);
                        }
                    });
                }
            });

            function limpiarCampos() {
                $('#serialesDropdown').val('');
                $('#manualEntry').val('').prop('disabled', true);
                $('#totalPoliza').val('');
                $('#tipo-doc').val('');
                $('#num-doc').val('');
                $('#Nombre').val('');
                $('#Apellido').val('');
                $('#fecha-factura').val('');
            }

            const form = document.getElementById('cupon-form');
            form.addEventListener('submit', SubmitText);

            function SubmitText(event) {
                event.preventDefault(); // Evitar el envío del formulario

                let valForm = ValidateError();
                if (valForm === true) {
                    let sucursalInfo = document.getElementById('SucursalDestino').value;
                    let numFac = document.getElementById('num-fac').value;
                    let tipoCed = document.getElementById('tipo-doc').value;
                    let Cedula = document.getElementById('num-doc').value;
                    let nombre = document.getElementById('Nombre').value;
                    let apellido = document.getElementById('Apellido').value;
                    let tipoNumCel = document.getElementById('cod-telf').value;
                    let numCel = document.getElementById('num-telf').value;
                    let fechaFactura = document.getElementById('fecha-factura').value;
                    let emailInfo = document.getElementById('Correo').value;
                    let country = $('#country').val().trim();
                    let state = $('#estado-emision').val().trim();
                    let municip = $('#municipio-emision').val().trim();
                    let ciudad = $('#ciudad-emision').val().trim();
                    let zona = $('#Zona-emision').val().trim();
                    let articulos = []; // Array para almacenar los artículos

                    facturaData.forEach(item => {
                        articulos.push({
                            codarticulo: item.codArticulo,
                            nomArticulo: item.descripcion
                        });
                    });

                    let dataDireccion = {
                        codeContry: country,
                        codeProvince: state,
                        codeCity: ciudad,
                        codeMunicipality: municip,
                        codeZone: zona
                    };

                    let dataFactura = {
                        InvoiceNumber: numFac,
                        idSucursal: sucursalInfo,
                        InvoiceDate: fechaFactura,
                        Cedula: Cedula,
                        StoreCode: sucursalInfo,
                        NameClient: nombre,
                        SurnameClient: apellido,
                        EmailClient: emailInfo,
                        PhoneNumberClient: tipoNumCel + numCel,
                        AddressClient: dataDireccion,
                        Articles: articulos
                    };

                    console.log(dataFactura);
                    SendMessageCoupon(dataFactura);
                }
            }

            async function SendMessageCoupon(data) {
                console.log(data);
                Swal.fire({
                    title: 'Cargando',
                    html: 'Por favor espera...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                try {
                    const response = await fetch("/Coupon/InfoClient", {
                        method: "POST",
                        body: JSON.stringify(data),
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });
                    if (response.ok) {
                        let data = await response.json();
                        console.log(data);
                        Swal.fire({
                            icon: 'success',
                            title: 'Éxito',
                            text: data.message
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        let errorData = await response.json();
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: errorData.message
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Hubo un problema al enviar los datos.'
                    });
                }
            }

            function ValidateError() {
                let sucursalInfo = document.getElementById('SucursalDestino').value;
                let numFac = document.getElementById('num-fac').value;
                let tipoCed = document.getElementById('tipo-doc').value;
                let cedula = document.getElementById('num-doc').value;
                let nombre = document.getElementById('Nombre').value;
                let apellido = document.getElementById('Apellido').value;
                let tipoNumCel = document.getElementById('cod-telf').value;
                let numCel = document.getElementById('num-telf').value;
                let fechaNac = document.getElementById('fecha-nac').value;
                let estadoCivil = document.getElementById('estado-civil').value;
                let generoCliente = document.getElementById('genero-cliente').value;
                let emailInfo = document.getElementById('Correo').value;
                let country = $('#country').val();
                let state = $('#estado-emision').val();
                let municip = $('#municipio-emision').val();
                let ciudad = $('#ciudad-emision').val();
                let zona = $('#Zona-emision').val();

                const errores = {
                    sucursal: document.getElementById("sucursal-error"),
                    numFac: document.getElementById("num-fac-error"),
                    tipoCed: document.getElementById("tipo-ced-error"),
                    numCed: document.getElementById("num-doc-error"),
                    nombre: document.getElementById("nombre-error"),
                    apellido: document.getElementById("apellido-error"),
                    tipoNumTelf: document.getElementById('cod-telf-error'),
                    numTelf: document.getElementById('num-telf-error'),
                    fechaNac: document.getElementById('fecha-nac-error'),
                    estadoCivil: document.getElementById('estado-civil-error'),
                    generoCliente: document.getElementById('genero-cliente-error'),
                    correo: document.getElementById('correo-error'),
                    pais: document.getElementById('country-error'),
                    estado: document.getElementById('estado-error'),
                    ciudad: document.getElementById('ciudad-error'),
                    municipio: document.getElementById('municipio-error'),
                    zona: document.getElementById('zona-error')
                };

                // Limpiar mensajes de error
                for (let key in errores) {
                    errores[key].textContent = '';
                }

                let isValid = true;

                if (sucursalInfo === '') {
                    errores.sucursal.textContent = 'Elige una sucursal';
                    isValid = false;
                }
                if (numFac === '') {
                    errores.numFac.textContent = "Ingresa el número de factura";
                    isValid = false;
                }
                if (tipoCed === '') {
                    errores.tipoCed.textContent = "Documento";
                    isValid = false;
                }
                if (cedula === '') {
                    errores.numCed.textContent = "Número Doc";
                    isValid = false;
                }
                if (nombre === '') {
                    errores.nombre.textContent = "Nombre";
                    isValid = false;
                }
                if (apellido === '') {
                    errores.apellido.textContent = "Apellido";
                    isValid = false;
                }
                if (tipoNumCel === '') {
                    errores.tipoNumTelf.textContent = "Elige";
                    isValid = false;
                }
                if (numCel === '') {
                    errores.numTelf.textContent = "Número teléfono";
                    isValid = false;
                }
                if (fechaNac === '') {
                    errores.fechaNac.textContent = 'Nacimiento';
                    isValid = false;
                }
                if (estadoCivil === '') {
                    errores.estadoCivil.textContent = 'Elige estado';
                    isValid = false;
                }
                if (generoCliente === '') {
                    errores.generoCliente.textContent = 'Elige';
                    isValid = false;
                }
                if (emailInfo === '') {
                    errores.correo.textContent = "Ingresa el correo";
                    isValid = false;
                }
                if (country === '') {
                    errores.pais.textContent = "País";
                    isValid = false;
                }
                if (state === '') {
                    errores.estado.textContent = "Estado";
                    isValid = false;
                }
                if (municip === '') {
                    errores.municipio.textContent = "Municipio";
                    isValid = false;
                }
                if (ciudad === '') {
                    errores.ciudad.textContent = "Ciudad";
                    isValid = false;
                }
                if (zona === '') {
                    errores.zona.textContent = "Zona";
                    isValid = false;
                }

                return isValid;
            }
        });
    </script>



</div>
